// ==========================================
// SELLAST ENTERPRISE POS - PRISMA SCHEMA (PROPUESTA)
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------
// USERS & AUTH (RBAC)
// ------------------------------------------

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      Role     @default(CASHIER)
  active    Boolean  @default(true)
  
  // Relaciones
  shifts    CashShift[]
  sales     Sale[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  SUPER_ADMIN
  MANAGER
  CASHIER
  WAREHOUSE
}

// ------------------------------------------
// CATALOGO
// ------------------------------------------

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  products    Product[]
}

model Product {
  id            String   @id @default(uuid())
  name          String
  description   String?
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id])
  
  // Impuestos
  taxRate       Decimal  @default(0.16) // IVA default MX
  
  // Relaciones
  variants      Variant[]
  
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Variant {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  
  sku           String   @unique
  barcode       String?  @unique
  name          String   // Ej: "Rojo / XL"
  
  costPrice     Decimal  @db.Decimal(10, 2)
  salePrice     Decimal  @db.Decimal(10, 2)
  
  // Stock por Almacén
  inventory     InventoryItem[]
  saleItems     SaleItem[]
}

// ------------------------------------------
// INVENTARIO & ALMACENES
// ------------------------------------------

model Warehouse {
  id        String          @id @default(uuid())
  name      String          // Ej: "Tienda Principal", "Bodega Central"
  address   String?
  inventory InventoryItem[]
}

model InventoryItem {
  id          String    @id @default(uuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  variantId   String
  variant     Variant   @relation(fields: [variantId], references: [id])
  
  quantity    Int       @default(0)
  minStock    Int       @default(5)
  maxStock    Int?
  location    String?   // Ubicación en pasillo/estante

  @@unique([warehouseId, variantId])
}

// ------------------------------------------
// VENTAS & POS
// ------------------------------------------

model CashShift {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  startTime     DateTime  @default(now())
  endTime       DateTime?
  
  startAmount   Decimal   @db.Decimal(10, 2)
  endAmount     Decimal?  @db.Decimal(10, 2) // Contado por cajero
  systemAmount  Decimal?  @db.Decimal(10, 2) // Calculado por sistema
  difference    Decimal?  @db.Decimal(10, 2)
  
  status        ShiftStatus @default(OPEN)
  
  movements     CashMovement[]
  sales         Sale[]
}

enum ShiftStatus {
  OPEN
  CLOSED
}

model Sale {
  id            String      @id @default(uuid()) // Folio interno
  displayId     Int         @default(autoincrement()) // Folio leíble
  
  shiftId       String?
  shift         CashShift?  @relation(fields: [shiftId], references: [id])
  
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  
  customerId    String?
  customer      Customer?   @relation(fields: [customerId], references: [id])
  
  total         Decimal     @db.Decimal(10, 2)
  subtotal      Decimal     @db.Decimal(10, 2)
  taxTotal      Decimal     @db.Decimal(10, 2)
  discountTotal Decimal     @db.Decimal(10, 2)
  
  paymentMethod PaymentMethod
  status        SaleStatus    @default(COMPLETED)
  
  items         SaleItem[]
  
  createdAt     DateTime    @default(now())
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
}

enum SaleStatus {
  COMPLETED
  CANCELLED
  REFUNDED
}

model SaleItem {
  id          String   @id @default(uuid())
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  
  variantId   String
  variant     Variant  @relation(fields: [variantId], references: [id])
  
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2) // Precio al momento de venta
  total       Decimal  @db.Decimal(10, 2)
}

model CashMovement {
  id          String   @id @default(uuid())
  shiftId     String
  shift       CashShift @relation(fields: [shiftId], references: [id])
  
  type        MovementType // INGRESO, RETIRO, VENTA
  amount      Decimal
  reason      String?
  
  createdAt   DateTime @default(now())
}

enum MovementType {
  SALE
  DEPOSIT
  WITHDRAWAL
}

// ------------------------------------------
// CLIENTES & CRM
// ------------------------------------------

model Customer {
  id            String   @id @default(uuid())
  name          String
  email         String?
  phone         String?
  taxId         String?  // RFC
  address       String?
  
  sales         Sale[]
  
  createdAt     DateTime @default(now())
}

// ------------------------------------------
// AUDITORIA
// ------------------------------------------

model AuditLog {
  id        String   @id @default(uuid())
  entity    String   // e.g. "Product"
  entityId  String
  action    String   // e.g. "UPDATE_PRICE"
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  details   Json?    // Before/After state
  createdAt DateTime @default(now())
}
