// ==========================================
// SELLAST ENTERPRISE POS & ECOMMERCE - UNIFIED SCHEMA
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url is managed by prisma.config.ts in v7
}

// ------------------------------------------
// USERS & AUTH (Shared)
// ------------------------------------------

model User {
  id     String  @id @default(uuid())
  email  String  @unique
  name   String?
  role   Role    @default(CUSTOMER) // Default to customer for web
  active Boolean @default(true)

  // Relations
  shifts    CashShift[]
  sales     Sale[] // POS Sales
  orders    Order[]       // Web Orders
  cart      CartItem[]
  addresses Address[]
  auditLogs AuditLog[]
  invoiceProfiles InvoiceProfile[]
  branches  UserBranch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  SUPER_ADMIN
  MANAGER
  CASHIER
  WAREHOUSE
  CUSTOMER
}

// ------------------------------------------
// CATALOGO (Shared)
// ------------------------------------------

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  products    Product[]
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])

  // Legacy / Web Fields
  sku    String? // Fallback if no variants
  price  Decimal  @default(0) // Display price
  stock  Int      @default(0) // Global stock fallback
  weight Decimal?

  // Impuestos
  taxRate Decimal @default(0.16) // IVA default MX

  // Relaciones
  variants   Variant[]
  images     Image[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Variant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  sku     String  @unique
  barcode String? @unique
  name    String // Ej: "Rojo / XL"

  costPrice Decimal @db.Decimal(10, 2)
  salePrice Decimal @db.Decimal(10, 2)

  // Stock por Almac√©n
  inventory  InventoryItem[]
  saleItems  SaleItem[]
  cartItems  CartItem[]
  orderItems OrderItem[]
}

model Image {
  id        String  @id @default(uuid())
  url       String
  isPrimary Boolean @default(false)
  productId String
  product   Product @relation(fields: [productId], references: [id])
}

// ------------------------------------------
// SUCURSALES (Multi-Branch)
// ------------------------------------------

model Branch {
  id          String   @id @default(uuid())
  name        String   // Ej: "Sucursal Centro", "Sucursal Norte"
  code        String   @unique // Ej: "SUC001", "SUC002"
  address     String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  isMain      Boolean  @default(false) // Sucursal principal
  
  // Configuration
  timezone    String   @default("America/Mexico_City")
  currency    String   @default("MXN")
  
  // Relations
  warehouses  Warehouse[]
  cashShifts  CashShift[]
  sales       Sale[]
  users       UserBranch[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserBranch {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id])
  isDefault Boolean  @default(false)
  
  @@unique([userId, branchId])
}

// ------------------------------------------
// INVENTARIO & ALMACENES (POS Core)
// ------------------------------------------

model Warehouse {
  id        String          @id @default(uuid())
  name      String // Ej: "Tienda Principal", "Bodega Central"
  address   String?
  branchId  String?
  branch    Branch?         @relation(fields: [branchId], references: [id])
  inventory InventoryItem[]
}

model InventoryItem {
  id          String    @id @default(uuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  variantId   String
  variant     Variant   @relation(fields: [variantId], references: [id])

  quantity Int     @default(0)
  minStock Int     @default(5)
  maxStock Int?
  location String?

  @@unique([warehouseId, variantId])
}

// ------------------------------------------
// CAJA & MOVIMIENTOS (POS Ops)
// ------------------------------------------

model CashShift {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])
  
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  startTime DateTime  @default(now())
  endTime   DateTime?

  startAmount  Decimal  @db.Decimal(10, 2)
  endAmount    Decimal? @db.Decimal(10, 2)
  systemAmount Decimal? @db.Decimal(10, 2)
  difference   Decimal? @db.Decimal(10, 2)

  status ShiftStatus @default(OPEN)

  movements CashMovement[]
  sales     Sale[]
}

enum ShiftStatus {
  OPEN
  CLOSED
}

model CashMovement {
  id      String    @id @default(uuid())
  shiftId String
  shift   CashShift @relation(fields: [shiftId], references: [id])

  type   MovementType // INGRESO, RETIRO, VENTA
  amount Decimal      @db.Decimal(10, 2)
  reason String?

  createdAt DateTime @default(now())
}

enum MovementType {
  SALE
  DEPOSIT
  WITHDRAWAL
}

// ------------------------------------------
// VENTAS POS (In-Store)
// ------------------------------------------

model Sale {
  id        String @id @default(uuid())
  displayId Int    @default(autoincrement())

  shiftId String?
  shift   CashShift? @relation(fields: [shiftId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  total         Decimal @db.Decimal(10, 2)
  subtotal      Decimal @db.Decimal(10, 2)
  taxTotal      Decimal @db.Decimal(10, 2)
  discountTotal Decimal @db.Decimal(10, 2)

  paymentMethod PaymentMethod
  status        SaleStatus    @default(COMPLETED)

  items SaleItem[]

  createdAt DateTime @default(now())
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
}

enum SaleStatus {
  COMPLETED
  CANCELLED
  REFUNDED
}

model SaleItem {
  id     String @id @default(uuid())
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  variantId String
  variant   Variant @relation(fields: [variantId], references: [id])

  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)
}

// ------------------------------------------
// E-COMMERCE (Web Orders)
// ------------------------------------------

model Order {
  id          String  @id @default(uuid())
  orderNumber String  @unique
  userId      String
  user        User    @relation(fields: [userId], references: [id])
  addressId   String
  address     Address @relation(fields: [addressId], references: [id])

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  subtotal     Decimal @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  shippingCost Decimal @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)

  shippingMethod  String?
  trackingNumber  String?
  courier         String?
  couponCode      String?
  customerNote    String?
  stripeSessionId String?
  invoice         Invoice?

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum OrderStatus {
  PENDING
  PROCESSING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
}

enum PaymentProvider {
  MERCADOPAGO
  STRIPE
  PAYPAL
  CASH
  TRANSFER
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  productId String
  product   Product  @relation(fields: [productId], references: [id])
  variantId String?
  variant   Variant? @relation(fields: [variantId], references: [id])

  name     String
  sku      String?
  price    Decimal @db.Decimal(10, 2)
  quantity Int
  subtotal Decimal @db.Decimal(10, 2)
}

model CartItem {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  productId String
  product   Product  @relation(fields: [productId], references: [id])
  variantId String?
  variant   Variant? @relation(fields: [variantId], references: [id])

  quantity Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  street    String
  extNumber String?
  intNumber String?
  colony    String?
  city      String
  state     String
  zipCode   String
  country   String  @default("MX")
  phone     String?

  isDefault Boolean @default(false)
  orders    Order[]
}

model Coupon {
  id          String     @id @default(uuid())
  code        String     @unique
  type        CouponType
  value       Decimal
  minPurchase Decimal?
  maxDiscount Decimal?

  validFrom  DateTime
  validUntil DateTime
  isActive   Boolean  @default(true)

  usageLimit Int?
  usageCount Int  @default(0)
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ------------------------------------------
// CLIENTES (CRM) - Shared with Users?
// ------------------------------------------

model Customer {
  id      String  @id @default(uuid())
  name    String
  email   String?
  phone   String?
  taxId   String?
  address String?

  // Can link to User if registered
  userId String?

  sales Sale[]

  createdAt DateTime @default(now())
}

// ------------------------------------------
// AUDITORIA
// ------------------------------------------

model AuditLog {
  id       String @id @default(uuid())
  entity   String
  entityId String
  action   String
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  details   Json?
  createdAt DateTime @default(now())
}

// ------------------------------------------
// FACTURACION (Fiscal)
// ------------------------------------------

model Invoice {
  id        String   @id @default(uuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  
  // Link to profile used
  invoiceProfileId String?
  invoiceProfile   InvoiceProfile? @relation(fields: [invoiceProfileId], references: [id])

  invoiceNumber String   @unique
  uuid          String?  // UUID del SAT
  xml           String?  // Contenido XML, o URL
  pdf           String?  // URL PDF
  status        InvoiceStatus   @default(PENDING)
  stampedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  PENDING
  ISSUED
  CANCELLED
  ERROR
}

model InvoiceProfile {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  rfc           String
  razonSocial   String
  regimenFiscal String
  usoCfdi       String
  codigoPostal  String
  email         String

  isDefault Boolean @default(false)
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------------------
// PROVEEDORES (Suppliers)
// ------------------------------------------

model Supplier {
  id      String  @id @default(uuid())
  name    String
  rfc     String?
  email   String?
  phone   String?
  address String?
  contact String?
  notes   String?

  purchaseOrders PurchaseOrder[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PurchaseOrder {
  id         String   @id @default(uuid())
  orderNumber String  @unique
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  status       PurchaseOrderStatus @default(PENDING)
  subtotal     Decimal @db.Decimal(10, 2)
  taxTotal     Decimal @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)

  expectedDate DateTime?
  receivedDate DateTime?
  notes        String?

  items PurchaseOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PurchaseOrderStatus {
  PENDING
  ORDERED
  PARTIAL
  RECEIVED
  CANCELLED
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  variantId    String?
  productName  String
  sku          String?
  quantity     Int
  unitCost     Decimal @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)
}

// ------------------------------------------
// GASTOS (Expenses)
// ------------------------------------------

model ExpenseCategory {
  id       String    @id @default(uuid())
  name     String    @unique
  color    String?
  expenses Expense[]
}

model Expense {
  id         String          @id @default(uuid())
  categoryId String
  category   ExpenseCategory @relation(fields: [categoryId], references: [id])

  concept     String
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @default(now())
  description String?
  receipt     String?  // URL to receipt image

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------------------
// COTIZACIONES (Quotations)
// ------------------------------------------

model Quotation {
  id    String @id @default(uuid())
  folio String @unique

  customerId   String?
  customerName String
  customerEmail String?
  customerPhone String?

  subtotal      Decimal @db.Decimal(10, 2)
  discountTotal Decimal @default(0) @db.Decimal(10, 2)
  taxTotal      Decimal @db.Decimal(10, 2)
  total         Decimal @db.Decimal(10, 2)

  status         QuotationStatus @default(PENDING)
  validUntil     DateTime
  paymentTerms   String?
  deliveryTerms  String?
  notes          String?

  items QuotationItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuotationStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

model QuotationItem {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])

  productName String
  sku         String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(10, 2)
}

